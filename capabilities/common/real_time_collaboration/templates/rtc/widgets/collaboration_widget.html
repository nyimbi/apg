<!-- Real-Time Collaboration Widget for Flask-AppBuilder Pages -->
<div id="rtc-collaboration-widget" class="rtc-widget" data-page-url="{{ data.page_url }}">
	<!-- Presence Indicator -->
	<div class="rtc-presence-bar">
		<div class="rtc-presence-users">
			<i class="fa fa-users"></i>
			<span id="rtc-user-count">0</span> online
		</div>
		<div class="rtc-presence-list" id="rtc-presence-list">
			<!-- Users populated by JavaScript -->
		</div>
	</div>

	<!-- Collaboration Controls -->
	<div class="rtc-controls">
		{% if data.chat_enabled %}
		<button id="rtc-toggle-chat" class="rtc-btn rtc-btn-primary" title="Toggle Chat">
			<i class="fa fa-comments"></i>
		</button>
		{% endif %}

		{% if data.form_delegation_enabled %}
		<button id="rtc-toggle-delegation" class="rtc-btn rtc-btn-success" title="Field Delegation">
			<i class="fa fa-hand-point-right"></i>
		</button>
		{% endif %}

		{% if data.assistance_enabled %}
		<button id="rtc-request-assistance" class="rtc-btn rtc-btn-warning" title="Request Assistance">
			<i class="fa fa-question-circle"></i>
		</button>
		{% endif %}

		<button id="rtc-start-video" class="rtc-btn rtc-btn-info" title="Start Video Call">
			<i class="fa fa-video"></i>
		</button>
	</div>

	<!-- Chat Panel -->
	<div id="rtc-chat-panel" class="rtc-panel rtc-chat-panel">
		<div class="rtc-panel-header">
			<h4><i class="fa fa-comments"></i> Page Chat</h4>
			<button class="rtc-close-panel">&times;</button>
		</div>
		<div class="rtc-chat-messages" id="rtc-chat-messages">
			<!-- Messages populated by JavaScript -->
		</div>
		<div class="rtc-chat-input">
			<input type="text" id="rtc-chat-input" placeholder="Type a message..." maxlength="500">
			<button id="rtc-send-message"><i class="fa fa-paper-plane"></i></button>
		</div>
	</div>

	<!-- Field Delegation Panel -->
	<div id="rtc-delegation-panel" class="rtc-panel rtc-delegation-panel">
		<div class="rtc-panel-header">
			<h4><i class="fa fa-hand-point-right"></i> Field Delegation</h4>
			<button class="rtc-close-panel">&times;</button>
		</div>
		<div class="rtc-delegation-content">
			<p>Click on a form field to delegate it to another user.</p>
			<div id="rtc-delegation-instructions" style="display: none;">
				<h5>Delegating: <span id="rtc-selected-field"></span></h5>
				<select id="rtc-delegatee-select" class="form-control">
					<option value="">Select user...</option>
				</select>
				<textarea id="rtc-delegation-notes" class="form-control mt-2" placeholder="Instructions (optional)"></textarea>
				<div class="mt-2">
					<button id="rtc-confirm-delegation" class="btn btn-success btn-sm">Delegate</button>
					<button id="rtc-cancel-delegation" class="btn btn-secondary btn-sm">Cancel</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Assistance Panel -->
	<div id="rtc-assistance-panel" class="rtc-panel rtc-assistance-panel">
		<div class="rtc-panel-header">
			<h4><i class="fa fa-question-circle"></i> Request Assistance</h4>
			<button class="rtc-close-panel">&times;</button>
		</div>
		<div class="rtc-assistance-content">
			<div class="form-group">
				<label>Field (optional):</label>
				<select id="rtc-assistance-field" class="form-control">
					<option value="">General page assistance</option>
				</select>
			</div>
			<div class="form-group">
				<label>Description:</label>
				<textarea id="rtc-assistance-description" class="form-control" placeholder="Describe what you need help with..." rows="3"></textarea>
			</div>
			<button id="rtc-send-assistance" class="btn btn-warning">Request Assistance</button>
		</div>
	</div>
</div>

<style>
.rtc-widget {
	position: fixed;
	top: 20px;
	right: 20px;
	z-index: 9999;
	max-width: 350px;
}

.rtc-presence-bar {
	background: rgba(255, 255, 255, 0.95);
	border: 1px solid #ddd;
	border-radius: 20px;
	padding: 8px 15px;
	margin-bottom: 10px;
	box-shadow: 0 2px 10px rgba(0,0,0,0.1);
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.rtc-presence-users {
	font-size: 0.9em;
	color: #666;
}

.rtc-presence-list {
	display: flex;
	flex-wrap: wrap;
	gap: 5px;
}

.rtc-presence-user {
	width: 24px;
	height: 24px;
	border-radius: 50%;
	background: #007bff;
	color: white;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 0.7em;
	font-weight: bold;
	position: relative;
}

.rtc-presence-user:hover::after {
	content: attr(data-name);
	position: absolute;
	top: -30px;
	left: 50%;
	transform: translateX(-50%);
	background: #333;
	color: white;
	padding: 2px 6px;
	border-radius: 3px;
	font-size: 0.8em;
	white-space: nowrap;
}

.rtc-controls {
	display: flex;
	gap: 5px;
	margin-bottom: 10px;
}

.rtc-btn {
	background: #007bff;
	color: white;
	border: none;
	border-radius: 50%;
	width: 40px;
	height: 40px;
	display: flex;
	align-items: center;
	justify-content: center;
	cursor: pointer;
	box-shadow: 0 2px 5px rgba(0,0,0,0.2);
	transition: all 0.2s;
}

.rtc-btn:hover {
	transform: scale(1.1);
}

.rtc-btn-primary { background: #007bff; }
.rtc-btn-success { background: #28a745; }
.rtc-btn-warning { background: #ffc107; color: #333; }
.rtc-btn-info { background: #17a2b8; }

.rtc-panel {
	background: white;
	border: 1px solid #ddd;
	border-radius: 8px;
	box-shadow: 0 4px 20px rgba(0,0,0,0.15);
	width: 100%;
	max-height: 400px;
	display: none;
	margin-bottom: 10px;
}

.rtc-panel-header {
	background: #f8f9fa;
	padding: 10px 15px;
	border-bottom: 1px solid #ddd;
	border-radius: 8px 8px 0 0;
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.rtc-panel-header h4 {
	margin: 0;
	font-size: 1em;
}

.rtc-close-panel {
	background: none;
	border: none;
	font-size: 1.5em;
	cursor: pointer;
	color: #666;
}

.rtc-chat-messages {
	height: 200px;
	overflow-y: auto;
	padding: 10px;
}

.rtc-chat-message {
	margin-bottom: 10px;
	padding: 8px;
	border-radius: 8px;
	background: #f8f9fa;
}

.rtc-chat-message.own {
	background: #007bff;
	color: white;
	margin-left: 20px;
}

.rtc-chat-input {
	display: flex;
	padding: 10px;
	border-top: 1px solid #ddd;
}

.rtc-chat-input input {
	flex: 1;
	border: 1px solid #ddd;
	border-radius: 15px;
	padding: 8px 12px;
	margin-right: 10px;
}

.rtc-chat-input button {
	background: #007bff;
	color: white;
	border: none;
	border-radius: 50%;
	width: 35px;
	height: 35px;
	cursor: pointer;
}

.rtc-delegation-content, .rtc-assistance-content {
	padding: 15px;
}

.rtc-field-highlight {
	outline: 2px solid #28a745 !important;
	outline-offset: 2px;
	cursor: pointer;
}

.rtc-field-delegated {
	background: rgba(40, 167, 69, 0.1) !important;
	border-left: 3px solid #28a745 !important;
}

.rtc-notification {
	position: fixed;
	top: 80px;
	right: 20px;
	background: #28a745;
	color: white;
	padding: 10px 15px;
	border-radius: 5px;
	box-shadow: 0 2px 10px rgba(0,0,0,0.2);
	z-index: 10000;
	animation: slideIn 0.3s ease;
}

@keyframes slideIn {
	from { transform: translateX(100%); }
	to { transform: translateX(0); }
}
</style>

<script>
// Initialize RTC Widget
document.addEventListener('DOMContentLoaded', function() {
	window.RTCWidget = new RealTimeCollaborationWidget();
});

class RealTimeCollaborationWidget {
	constructor() {
		this.pageUrl = document.querySelector('#rtc-collaboration-widget').dataset.pageUrl;
		this.websocket = null;
		this.currentUser = null;
		this.presenceUsers = [];
		this.delegationMode = false;
		
		this.initializeWebSocket();
		this.bindEvents();
		this.detectFormFields();
	}
	
	initializeWebSocket() {
		const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
		const wsUrl = `${protocol}//${window.location.host}/api/v1/rtc/ws/tenant123/user123?page_url=${encodeURIComponent(this.pageUrl)}`;
		
		this.websocket = new WebSocket(wsUrl);
		
		this.websocket.onopen = () => {
			console.log('RTC WebSocket connected');
			this.sendPresence();
		};
		
		this.websocket.onmessage = (event) => {
			const data = JSON.parse(event.data);
			this.handleWebSocketMessage(data);
		};
		
		this.websocket.onclose = () => {
			console.log('RTC WebSocket disconnected');
			setTimeout(() => this.initializeWebSocket(), 5000); // Reconnect
		};
	}
	
	bindEvents() {
		// Chat toggle
		document.getElementById('rtc-toggle-chat').addEventListener('click', () => {
			this.togglePanel('rtc-chat-panel');
		});
		
		// Send message
		document.getElementById('rtc-send-message').addEventListener('click', () => {
			this.sendChatMessage();
		});
		
		document.getElementById('rtc-chat-input').addEventListener('keypress', (e) => {
			if (e.key === 'Enter') this.sendChatMessage();
		});
		
		// Delegation toggle
		document.getElementById('rtc-toggle-delegation').addEventListener('click', () => {
			this.toggleDelegationMode();
		});
		
		// Assistance request
		document.getElementById('rtc-request-assistance').addEventListener('click', () => {
			this.togglePanel('rtc-assistance-panel');
		});
		
		// Video call
		document.getElementById('rtc-start-video').addEventListener('click', () => {
			this.startVideoCall();
		});
		
		// Close panels
		document.querySelectorAll('.rtc-close-panel').forEach(btn => {
			btn.addEventListener('click', (e) => {
				e.target.closest('.rtc-panel').style.display = 'none';
			});
		});
	}
	
	detectFormFields() {
		const fields = document.querySelectorAll('input, select, textarea');
		const fieldSelect = document.getElementById('rtc-assistance-field');
		
		fields.forEach((field, index) => {
			if (field.name || field.id) {
				const fieldName = field.name || field.id;
				const option = document.createElement('option');
				option.value = fieldName;
				option.textContent = fieldName;
				fieldSelect.appendChild(option);
				
				// Add click handler for delegation
				field.addEventListener('click', () => {
					if (this.delegationMode) {
						this.selectFieldForDelegation(fieldName, field);
					}
				});
			}
		});
	}
	
	togglePanel(panelId) {
		const panel = document.getElementById(panelId);
		panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
	}
	
	toggleDelegationMode() {
		this.delegationMode = !this.delegationMode;
		const btn = document.getElementById('rtc-toggle-delegation');
		
		if (this.delegationMode) {
			btn.style.background = '#dc3545';
			this.togglePanel('rtc-delegation-panel');
			this.highlightFormFields();
		} else {
			btn.style.background = '#28a745';
			this.removeFieldHighlights();
		}
	}
	
	highlightFormFields() {
		document.querySelectorAll('input, select, textarea').forEach(field => {
			field.classList.add('rtc-field-highlight');
		});
	}
	
	removeFieldHighlights() {
		document.querySelectorAll('.rtc-field-highlight').forEach(field => {
			field.classList.remove('rtc-field-highlight');
		});
	}
	
	selectFieldForDelegation(fieldName, field) {
		document.getElementById('rtc-selected-field').textContent = fieldName;
		document.getElementById('rtc-delegation-instructions').style.display = 'block';
		
		// Populate delegatee options
		const select = document.getElementById('rtc-delegatee-select');
		select.innerHTML = '<option value="">Select user...</option>';
		this.presenceUsers.forEach(user => {
			if (user.user_id !== this.currentUser?.user_id) {
				const option = document.createElement('option');
				option.value = user.user_id;
				option.textContent = user.display_name;
				select.appendChild(option);
			}
		});
		
		document.getElementById('rtc-confirm-delegation').onclick = () => {
			this.confirmDelegation(fieldName);
		};
		
		document.getElementById('rtc-cancel-delegation').onclick = () => {
			this.cancelDelegation();
		};
	}
	
	confirmDelegation(fieldName) {
		const delegateeId = document.getElementById('rtc-delegatee-select').value;
		const notes = document.getElementById('rtc-delegation-notes').value;
		
		if (!delegateeId) {
			alert('Please select a user to delegate to');
			return;
		}
		
		// Send delegation request
		fetch('/api/v1/rtc/page-collaboration/delegate-field', {
			method: 'POST',
			headers: {'Content-Type': 'application/json'},
			body: JSON.stringify({
				field_name: fieldName,
				delegatee_id: delegateeId,
				instructions: notes,
				page_url: this.pageUrl
			})
		}).then(response => response.json())
		.then(data => {
			this.showNotification('Field delegated successfully');
			this.cancelDelegation();
		});
	}
	
	cancelDelegation() {
		document.getElementById('rtc-delegation-instructions').style.display = 'none';
		this.toggleDelegationMode();
	}
	
	sendChatMessage() {
		const input = document.getElementById('rtc-chat-input');
		const message = input.value.trim();
		
		if (message) {
			fetch('/api/v1/rtc/chat/messages', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({
					message: message,
					page_url: this.pageUrl
				})
			});
			
			input.value = '';
		}
	}
	
	startVideoCall() {
		const callName = prompt('Video call name:', `Call for ${this.pageUrl}`);
		if (callName) {
			fetch('/api/v1/rtc/video-calls', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({
					call_name: callName,
					page_url: this.pageUrl
				})
			}).then(response => response.json())
			.then(data => {
				window.open(`/rtc-video/meeting/${data.call_id}`, '_blank');
			});
		}
	}
	
	sendPresence() {
		if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
			this.websocket.send(JSON.stringify({
				type: 'presence',
				page_url: this.pageUrl,
				user_info: {
					display_name: 'Current User',  // Would get from APG auth
					role: 'collaborator'
				}
			}));
		}
	}
	
	handleWebSocketMessage(data) {
		switch (data.type) {
			case 'presence_update':
				this.updatePresence(data.users);
				break;
			case 'chat_message':
				this.addChatMessage(data);
				break;
			case 'form_delegation':
				this.handleDelegationNotification(data);
				break;
			case 'assistance_request':
				this.handleAssistanceRequest(data);
				break;
		}
	}
	
	updatePresence(users) {
		this.presenceUsers = users;
		document.getElementById('rtc-user-count').textContent = users.length;
		
		const presenceList = document.getElementById('rtc-presence-list');
		presenceList.innerHTML = '';
		
		users.forEach(user => {
			const userEl = document.createElement('div');
			userEl.className = 'rtc-presence-user';
			userEl.setAttribute('data-name', user.display_name);
			userEl.textContent = user.display_name.charAt(0).toUpperCase();
			presenceList.appendChild(userEl);
		});
	}
	
	addChatMessage(data) {
		const messagesEl = document.getElementById('rtc-chat-messages');
		const messageEl = document.createElement('div');
		messageEl.className = 'rtc-chat-message';
		messageEl.innerHTML = `
			<strong>${data.username}:</strong> ${data.message}
			<div style="font-size: 0.8em; color: #666; margin-top: 3px;">
				${new Date(data.timestamp).toLocaleTimeString()}
			</div>
		`;
		
		messagesEl.appendChild(messageEl);
		messagesEl.scrollTop = messagesEl.scrollHeight;
	}
	
	handleDelegationNotification(data) {
		this.showNotification(`Field "${data.field_name}" has been delegated to you`);
		
		// Highlight delegated field
		const field = document.querySelector(`[name="${data.field_name}"], #${data.field_name}`);
		if (field) {
			field.classList.add('rtc-field-delegated');
		}
	}
	
	handleAssistanceRequest(data) {
		this.showNotification(`${data.requester_name} requested assistance with "${data.field_name || 'page'}"`);
	}
	
	showNotification(message) {
		const notification = document.createElement('div');
		notification.className = 'rtc-notification';
		notification.textContent = message;
		document.body.appendChild(notification);
		
		setTimeout(() => {
			notification.remove();
		}, 5000);
	}
}
</script>