{% extends "appbuilder/general/model/base.html" %}

{% block title %}Video Call Control Panel{% endblock %}

{% block head_css %}
{{ super() }}
<style>
.rtc-video-control {
	padding: 20px;
}

.rtc-call-card {
	background: #fff;
	border-radius: 8px;
	box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	padding: 20px;
	margin-bottom: 20px;
	border-left: 4px solid #007bff;
}

.rtc-call-status {
	display: inline-block;
	padding: 3px 8px;
	border-radius: 12px;
	font-size: 0.8em;
	font-weight: bold;
}

.rtc-call-status.active {
	background: #d4edda;
	color: #155724;
}

.rtc-call-status.scheduled {
	background: #fff3cd;
	color: #856404;
}

.rtc-call-controls {
	margin-top: 15px;
}

.rtc-call-controls .btn {
	margin-right: 10px;
	margin-bottom: 5px;
}

.rtc-participants {
	margin-top: 10px;
}

.rtc-participant {
	display: inline-block;
	margin: 2px;
	padding: 2px 6px;
	background: #e9ecef;
	border-radius: 3px;
	font-size: 0.8em;
}

.rtc-features {
	margin-top: 10px;
}

.rtc-feature {
	display: inline-block;
	margin: 2px;
	padding: 2px 6px;
	background: #007bff;
	color: white;
	border-radius: 3px;
	font-size: 0.7em;
}
</style>
{% endblock %}

{% block content %}
<div class="rtc-video-control">
	<div class="row">
		<div class="col-12">
			<h1><i class="fa fa-video"></i> Video Call Control Panel</h1>
			<p class="lead">Manage video calls with Teams/Zoom/Meet integration</p>
		</div>
	</div>

	<!-- Quick Start -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="rtc-call-card">
				<h3><i class="fa fa-plus"></i> Start New Call</h3>
				<form method="post" action="{{ url_for('RTCVideoCallModelView.add') }}" class="form-inline">
					<div class="form-group mr-3">
						<input type="text" class="form-control" name="call_name" placeholder="Meeting Name" required>
					</div>
					<div class="form-group mr-3">
						<select name="call_type" class="form-control">
							<option value="video">Video Call</option>
							<option value="audio">Audio Only</option>
							<option value="webinar">Webinar</option>
						</select>
					</div>
					<button type="submit" class="btn btn-primary">
						<i class="fa fa-video"></i> Start Call
					</button>
				</form>
			</div>
		</div>
	</div>

	<!-- Active Calls -->
	<div class="row">
		<div class="col-12">
			<h2><i class="fa fa-play"></i> Active Calls</h2>
			{% for call in active_calls %}
			<div class="rtc-call-card">
				<div class="d-flex justify-content-between align-items-start">
					<div>
						<h4>{{ call.call_name }}</h4>
						<span class="rtc-call-status active">Active</span>
						<div class="mt-2">
							<small class="text-muted">
								Started: {{ call.started_at }} | 
								Duration: {{ call.duration }} | 
								Host: {{ call.host_name }}
							</small>
						</div>
					</div>
					<div class="text-right">
						<div class="h5">{{ call.participant_count }}/{{ call.max_participants }}</div>
						<small class="text-muted">participants</small>
					</div>
				</div>

				<div class="rtc-participants">
					<strong>Participants:</strong>
					{% for participant in call.participants %}
					<span class="rtc-participant">{{ participant.name }}</span>
					{% endfor %}
				</div>

				<div class="rtc-features">
					<strong>Features:</strong>
					{% if call.recording_enabled %}
					<span class="rtc-feature">Recording</span>
					{% endif %}
					{% if call.screen_sharing %}
					<span class="rtc-feature">Screen Share</span>
					{% endif %}
					{% if call.breakout_rooms %}
					<span class="rtc-feature">Breakout Rooms</span>
					{% endif %}
				</div>

				<div class="rtc-call-controls">
					<a href="/rtc-video/meeting/{{ call.call_id }}" class="btn btn-success">
						<i class="fa fa-sign-in-alt"></i> Join Call
					</a>
					<button class="btn btn-warning" onclick="muteAll('{{ call.call_id }}')">
						<i class="fa fa-volume-mute"></i> Mute All
					</button>
					<button class="btn btn-info" onclick="startRecording('{{ call.call_id }}')">
						<i class="fa fa-record-vinyl"></i> Start Recording
					</button>
					<button class="btn btn-secondary" onclick="createBreakoutRooms('{{ call.call_id }}')">
						<i class="fa fa-users"></i> Breakout Rooms
					</button>
					<button class="btn btn-danger" onclick="endCall('{{ call.call_id }}')">
						<i class="fa fa-phone-slash"></i> End Call
					</button>
				</div>
			</div>
			{% else %}
			<div class="rtc-call-card">
				<div class="text-center text-muted">
					<i class="fa fa-video fa-3x mb-3"></i>
					<h4>No Active Calls</h4>
					<p>Start a new video call to begin collaborating</p>
				</div>
			</div>
			{% endfor %}
		</div>
	</div>

	<!-- Third-Party Integration Status -->
	<div class="row mt-4">
		<div class="col-12">
			<div class="rtc-call-card">
				<h3><i class="fa fa-plug"></i> Integration Status</h3>
				<div class="row">
					<div class="col-md-4">
						<div class="text-center">
							<i class="fa fa-microsoft fa-2x text-primary"></i>
							<div class="mt-2">
								<strong>Microsoft Teams</strong>
								<div class="rtc-call-status active">Connected</div>
							</div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="text-center">
							<i class="fa fa-video fa-2x text-info"></i>
							<div class="mt-2">
								<strong>Zoom</strong>
								<div class="rtc-call-status active">Connected</div>
							</div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="text-center">
							<i class="fa fa-google fa-2x text-warning"></i>
							<div class="mt-2">
								<strong>Google Meet</strong>
								<div class="rtc-call-status active">Connected</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
function muteAll(callId) {
	if (confirm('Mute all participants?')) {
		fetch(`/api/v1/rtc/video-calls/${callId}/mute-all`, {method: 'POST'})
			.then(response => response.json())
			.then(data => alert('All participants muted'));
	}
}

function startRecording(callId) {
	fetch(`/api/v1/rtc/video-calls/${callId}/recording`, {method: 'POST'})
		.then(response => response.json())
		.then(data => alert('Recording started'));
}

function createBreakoutRooms(callId) {
	const rooms = prompt('Number of breakout rooms:', '3');
	if (rooms) {
		fetch(`/api/v1/rtc/video-calls/${callId}/breakout-rooms`, {
			method: 'POST',
			headers: {'Content-Type': 'application/json'},
			body: JSON.stringify({room_count: parseInt(rooms)})
		})
		.then(response => response.json())
		.then(data => alert('Breakout rooms created'));
	}
}

function endCall(callId) {
	if (confirm('End this call for all participants?')) {
		fetch(`/api/v1/rtc/video-calls/${callId}`, {method: 'DELETE'})
			.then(response => response.json())
			.then(data => {
				alert('Call ended');
				location.reload();
			});
	}
}
</script>
{% endblock %}