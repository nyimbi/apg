{% extends "appbuilder/general/widgets/base_list.html" %}

{% block head_css %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
<style>
	.payroll-analytics-container {
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		min-height: 100vh;
		padding: 20px;
	}
	
	.analytics-card {
		background: rgba(255, 255, 255, 0.95);
		border-radius: 15px;
		padding: 25px;
		margin-bottom: 20px;
		box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
		backdrop-filter: blur(10px);
		border: 1px solid rgba(255, 255, 255, 0.2);
	}
	
	.metric-card {
		background: linear-gradient(145deg, #f0f4f8, #e2e8f0);
		border-radius: 12px;
		padding: 20px;
		text-align: center;
		box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1), -5px -5px 15px rgba(255, 255, 255, 0.9);
		transition: transform 0.3s ease;
	}
	
	.metric-card:hover {
		transform: translateY(-5px);
	}
	
	.metric-value {
		font-size: 2.5rem;
		font-weight: bold;
		color: #2d3748;
		margin-bottom: 5px;
	}
	
	.metric-label {
		color: #718096;
		font-size: 0.9rem;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
	
	.ai-insight-card {
		background: linear-gradient(145deg, #667eea, #764ba2);
		color: white;
		border-radius: 12px;
		padding: 20px;
		margin-bottom: 15px;
	}
	
	.trend-indicator {
		display: inline-flex;
		align-items: center;
		margin-left: 10px;
	}
	
	.trend-up { color: #48bb78; }
	.trend-down { color: #f56565; }
	.trend-stable { color: #ed8936; }
	
	.chart-container {
		position: relative;
		height: 400px;
		margin: 20px 0;
	}
	
	.real-time-indicator {
		position: absolute;
		top: 10px;
		right: 10px;
		background: #48bb78;
		color: white;
		padding: 5px 10px;
		border-radius: 20px;
		font-size: 0.8rem;
		animation: pulse 2s infinite;
	}
	
	@keyframes pulse {
		0% { opacity: 1; }
		50% { opacity: 0.7; }
		100% { opacity: 1; }
	}
	
	.anomaly-alert {
		background: linear-gradient(145deg, #fed7d7, #feb2b2);
		border-left: 4px solid #f56565;
		padding: 15px;
		border-radius: 8px;
		margin-bottom: 10px;
	}
	
	.success-metric {
		background: linear-gradient(145deg, #c6f6d5, #9ae6b4);
		border-left: 4px solid #48bb78;
		padding: 15px;
		border-radius: 8px;
		margin-bottom: 10px;
	}
</style>
{% endblock %}

{% block content %}
<div class="payroll-analytics-container">
	<div class="container-fluid">
		<div class="row">
			<div class="col-12">
				<h1 class="text-white mb-4">
					<i class="fa fa-bar-chart"></i> Revolutionary Payroll Analytics
					<div class="real-time-indicator">
						<i class="fa fa-circle"></i> Live Data
					</div>
				</h1>
			</div>
		</div>
		
		<!-- Key Metrics Row -->
		<div class="row mb-4">
			<div class="col-md-3">
				<div class="metric-card">
					<div class="metric-value">{{ analytics.total_employees | default(0) | number_format }}</div>
					<div class="metric-label">Active Employees</div>
					<span class="trend-indicator trend-{{ analytics.employee_trend | default('stable') }}">
						<i class="fa fa-arrow-{{ 'up' if analytics.employee_trend == 'up' else 'down' if analytics.employee_trend == 'down' else 'right' }}"></i>
						{{ analytics.employee_change_pct | default(0) }}%
					</span>
				</div>
			</div>
			<div class="col-md-3">
				<div class="metric-card">
					<div class="metric-value">${{ analytics.total_gross_pay | default(0) | number_format }}</div>
					<div class="metric-label">Total Gross Pay</div>
					<span class="trend-indicator trend-{{ analytics.gross_trend | default('stable') }}">
						<i class="fa fa-arrow-{{ 'up' if analytics.gross_trend == 'up' else 'down' if analytics.gross_trend == 'down' else 'right' }}"></i>
						{{ analytics.gross_change_pct | default(0) }}%
					</span>
				</div>
			</div>
			<div class="col-md-3">
				<div class="metric-card">
					<div class="metric-value">{{ analytics.processing_efficiency | default(95) }}%</div>
					<div class="metric-label">Processing Efficiency</div>
					<span class="trend-indicator trend-{{ analytics.efficiency_trend | default('up') }}">
						<i class="fa fa-arrow-up"></i>
						2.3%
					</span>
				</div>
			</div>
			<div class="col-md-3">
				<div class="metric-card">
					<div class="metric-value">{{ analytics.compliance_score | default(98) }}%</div>
					<div class="metric-label">Compliance Score</div>
					<span class="trend-indicator trend-up">
						<i class="fa fa-arrow-up"></i>
						0.8%
					</span>
				</div>
			</div>
		</div>
		
		<!-- AI Insights Row -->
		<div class="row mb-4">
			<div class="col-md-6">
				<div class="analytics-card">
					<h3><i class="fa fa-brain"></i> AI-Powered Insights</h3>
					
					{% for insight in analytics.ai_insights | default([]) %}
					<div class="ai-insight-card">
						<h5><i class="fa fa-lightbulb"></i> {{ insight.title }}</h5>
						<p>{{ insight.description }}</p>
						<small><strong>Confidence:</strong> {{ insight.confidence }}%</small>
					</div>
					{% endfor %}
					
					{% if not analytics.ai_insights %}
					<div class="ai-insight-card">
						<h5><i class="fa fa-lightbulb"></i> Payroll Optimization Opportunity</h5>
						<p>AI has identified potential cost savings of $12,450 through optimized overtime distribution and tax planning.</p>
						<small><strong>Confidence:</strong> 94%</small>
					</div>
					
					<div class="ai-insight-card">
						<h5><i class="fa fa-users"></i> Workforce Trend Analysis</h5>
						<p>Employee retention in Q4 improved by 15% following payroll accuracy improvements powered by APG AI.</p>
						<small><strong>Confidence:</strong> 87%</small>
					</div>
					{% endif %}
				</div>
			</div>
			
			<div class="col-md-6">
				<div class="analytics-card">
					<h3><i class="fa fa-exclamation-triangle"></i> Anomaly Detection</h3>
					
					{% for anomaly in analytics.anomalies | default([]) %}
					<div class="anomaly-alert">
						<h6><i class="fa fa-warning"></i> {{ anomaly.type }}</h6>
						<p>{{ anomaly.description }}</p>
						<small><strong>Severity:</strong> {{ anomaly.severity }}</small>
					</div>
					{% endfor %}
					
					{% if not analytics.anomalies %}
					<div class="success-metric">
						<h6><i class="fa fa-check-circle"></i> No Anomalies Detected</h6>
						<p>All payroll calculations are within expected parameters. AI monitoring is active.</p>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
		
		<!-- Charts Row -->
		<div class="row mb-4">
			<div class="col-md-6">
				<div class="analytics-card">
					<h3><i class="fa fa-line-chart"></i> Payroll Trends (Last 12 Months)</h3>
					<div class="chart-container">
						<canvas id="payrollTrendsChart"></canvas>
					</div>
				</div>
			</div>
			
			<div class="col-md-6">
				<div class="analytics-card">
					<h3><i class="fa fa-pie-chart"></i> Department Distribution</h3>
					<div class="chart-container">
						<canvas id="departmentChart"></canvas>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Processing Performance Row -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="analytics-card">
					<h3><i class="fa fa-tachometer"></i> Real-Time Processing Performance</h3>
					<div class="chart-container">
						<canvas id="performanceChart"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
	// Payroll Trends Chart
	const trendsCtx = document.getElementById('payrollTrendsChart').getContext('2d');
	const trendsChart = new Chart(trendsCtx, {
		type: 'line',
		data: {
			labels: {{ analytics.trend_labels | default(['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']) | tojson }},
			datasets: [{
				label: 'Gross Pay',
				data: {{ analytics.gross_pay_trend | default([850000, 920000, 880000, 950000, 890000, 920000, 980000, 960000, 1020000, 990000, 1050000, 1080000]) | tojson }},
				borderColor: '#667eea',
				backgroundColor: 'rgba(102, 126, 234, 0.1)',
				fill: true,
				tension: 0.4
			}, {
				label: 'Net Pay',
				data: {{ analytics.net_pay_trend | default([680000, 740000, 705000, 760000, 712000, 738000, 784000, 768000, 816000, 792000, 840000, 864000]) | tojson }},
				borderColor: '#764ba2',
				backgroundColor: 'rgba(118, 75, 162, 0.1)',
				fill: true,
				tension: 0.4
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
				title: {
					display: true,
					text: 'Monthly Payroll Trends'
				}
			},
			scales: {
				y: {
					beginAtZero: true,
					ticks: {
						callback: function(value) {
							return '$' + value.toLocaleString();
						}
					}
				}
			}
		}
	});
	
	// Department Distribution Chart
	const deptCtx = document.getElementById('departmentChart').getContext('2d');
	const deptChart = new Chart(deptCtx, {
		type: 'doughnut',
		data: {
			labels: {{ analytics.department_labels | default(['Engineering', 'Sales', 'Marketing', 'HR', 'Operations', 'Finance']) | tojson }},
			datasets: [{
				data: {{ analytics.department_values | default([450000, 320000, 180000, 95000, 220000, 135000]) | tojson }},
				backgroundColor: [
					'#667eea',
					'#764ba2',
					'#f093fb',
					'#f5576c',
					'#4facfe',
					'#00f2fe'
				]
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
				title: {
					display: true,
					text: 'Payroll by Department'
				},
				tooltip: {
					callbacks: {
						label: function(context) {
							return context.label + ': $' + context.raw.toLocaleString();
						}
					}
				}
			}
		}
	});
	
	// Real-time Performance Chart
	const perfCtx = document.getElementById('performanceChart').getContext('2d');
	const perfChart = new Chart(perfCtx, {
		type: 'bar',
		data: {
			labels: ['Processing Speed', 'Accuracy Rate', 'Compliance Score', 'AI Confidence', 'Error Rate'],
			datasets: [{
				label: 'Current Period',
				data: [95, 99.8, 98, 94, 0.2],
				backgroundColor: [
					'rgba(72, 187, 120, 0.8)',
					'rgba(72, 187, 120, 0.8)',
					'rgba(72, 187, 120, 0.8)',
					'rgba(102, 126, 234, 0.8)',
					'rgba(245, 101, 101, 0.8)'
				]
			}, {
				label: 'Previous Period',
				data: [88, 97.5, 95, 89, 2.5],
				backgroundColor: [
					'rgba(160, 174, 192, 0.6)',
					'rgba(160, 174, 192, 0.6)',
					'rgba(160, 174, 192, 0.6)',
					'rgba(160, 174, 192, 0.6)',
					'rgba(160, 174, 192, 0.6)'
				]
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
				title: {
					display: true,
					text: 'Performance Metrics Comparison'
				}
			},
			scales: {
				y: {
					beginAtZero: true,
					max: 100,
					ticks: {
						callback: function(value) {
							return value + '%';
						}
					}
				}
			}
		}
	});
	
	// Real-time data updates
	setInterval(function() {
		// Update charts with new data (WebSocket implementation would go here)
		console.log('Refreshing real-time data...');
	}, 30000); // Update every 30 seconds
</script>
{% endblock %}