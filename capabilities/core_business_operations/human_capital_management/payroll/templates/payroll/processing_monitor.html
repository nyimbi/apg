{% extends "appbuilder/general/widgets/base.html" %}

{% block head_css %}
{{ super() }}
<style>
	.processing-monitor-container {
		background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
		min-height: 100vh;
		padding: 20px;
		color: white;
	}
	
	.monitor-card {
		background: rgba(255, 255, 255, 0.95);
		border-radius: 15px;
		padding: 25px;
		margin-bottom: 20px;
		box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
		backdrop-filter: blur(10px);
		color: #2d3748;
	}
	
	.status-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 30px;
	}
	
	.status-badge {
		display: inline-flex;
		align-items: center;
		padding: 8px 16px;
		border-radius: 20px;
		font-weight: 600;
		font-size: 0.9rem;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
	
	.status-processing {
		background: linear-gradient(145deg, #3182ce, #2c5aa0);
		color: white;
		animation: pulse 2s infinite;
	}
	
	.status-completed {
		background: linear-gradient(145deg, #48bb78, #38a169);
		color: white;
	}
	
	.status-error {
		background: linear-gradient(145deg, #f56565, #e53e3e);
		color: white;
	}
	
	.status-warning {
		background: linear-gradient(145deg, #ed8936, #dd6b20);
		color: white;
	}
	
	.progress-section {
		margin-bottom: 30px;
	}
	
	.progress-bar-container {
		background: #e2e8f0;
		border-radius: 10px;
		height: 20px;
		overflow: hidden;
		position: relative;
		margin: 15px 0;
	}
	
	.progress-bar {
		height: 100%;
		background: linear-gradient(90deg, #667eea, #764ba2);
		border-radius: 10px;
		transition: width 1s ease;
		position: relative;
	}
	
	.progress-bar::after {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		bottom: 0;
		right: 0;
		background: linear-gradient(
			90deg,
			transparent,
			rgba(255, 255, 255, 0.4),
			transparent
		);
		animation: shimmer 2s infinite;
	}
	
	@keyframes shimmer {
		0% { transform: translateX(-100%); }
		100% { transform: translateX(100%); }
	}
	
	.progress-text {
		text-align: center;
		font-weight: 600;
		margin-top: 10px;
		font-size: 1.1rem;
	}
	
	.stage-indicator {
		display: flex;
		justify-content: space-between;
		margin: 20px 0;
		position: relative;
	}
	
	.stage-indicator::before {
		content: '';
		position: absolute;
		top: 20px;
		left: 0;
		right: 0;
		height: 2px;
		background: #e2e8f0;
		z-index: 1;
	}
	
	.stage-step {
		display: flex;
		flex-direction: column;
		align-items: center;
		position: relative;
		z-index: 2;
		flex: 1;
	}
	
	.stage-circle {
		width: 40px;
		height: 40px;
		border-radius: 50%;
		background: #e2e8f0;
		display: flex;
		align-items: center;
		justify-content: center;
		margin-bottom: 10px;
		font-weight: bold;
		transition: all 0.3s ease;
	}
	
	.stage-circle.completed {
		background: linear-gradient(145deg, #48bb78, #38a169);
		color: white;
	}
	
	.stage-circle.active {
		background: linear-gradient(145deg, #667eea, #764ba2);
		color: white;
		animation: pulse 2s infinite;
	}
	
	.stage-label {
		font-size: 0.8rem;
		text-align: center;
		font-weight: 600;
		color: #718096;
	}
	
	.stage-label.active {
		color: #667eea;
	}
	
	.stage-label.completed {
		color: #48bb78;
	}
	
	.metrics-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 20px;
		margin-bottom: 30px;
	}
	
	.metric-item {
		background: linear-gradient(145deg, #f7fafc, #edf2f7);
		border-radius: 10px;
		padding: 20px;
		text-align: center;
		border: 1px solid #e2e8f0;
	}
	
	.metric-value {
		font-size: 2rem;
		font-weight: bold;
		color: #2d3748;
		margin-bottom: 5px;
	}
	
	.metric-label {
		color: #718096;
		font-size: 0.9rem;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
	
	.real-time-log {
		background: #1a202c;
		border-radius: 10px;
		padding: 20px;
		font-family: 'Monaco', 'Menlo', monospace;
		font-size: 0.85rem;
		max-height: 300px;
		overflow-y: auto;
		border: 1px solid #4a5568;
	}
	
	.log-entry {
		margin-bottom: 5px;
		display: flex;
		align-items: flex-start;
	}
	
	.log-timestamp {
		color: #63b3ed;
		margin-right: 10px;
		min-width: 80px;
	}
	
	.log-level {
		margin-right: 10px;
		font-weight: bold;
		min-width: 50px;
	}
	
	.log-level.info { color: #68d391; }
	.log-level.warn { color: #fbd38d; }
	.log-level.error { color: #fc8181; }
	
	.log-message {
		color: #e2e8f0;
		flex: 1;
	}
	
	.employee-progress {
		background: #f7fafc;
		border-radius: 10px;
		padding: 20px;
		margin: 20px 0;
	}
	
	.employee-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
		gap: 15px;
		margin-top: 15px;
	}
	
	.employee-card {
		background: white;
		border-radius: 8px;
		padding: 15px;
		border-left: 4px solid #e2e8f0;
		transition: all 0.3s ease;
	}
	
	.employee-card.processing {
		border-left-color: #667eea;
		background: #f0f4ff;
	}
	
	.employee-card.completed {
		border-left-color: #48bb78;
		background: #f0fff4;
	}
	
	.employee-card.error {
		border-left-color: #f56565;
		background: #fff5f5;
	}
	
	.employee-name {
		font-weight: 600;
		margin-bottom: 5px;
	}
	
	.employee-status {
		font-size: 0.8rem;
		color: #718096;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
	
	.refresh-indicator {
		position: fixed;
		top: 20px;
		right: 20px;
		background: rgba(102, 126, 234, 0.9);
		color: white;
		padding: 10px 20px;
		border-radius: 20px;
		display: none;
		align-items: center;
		gap: 10px;
		z-index: 1000;
		backdrop-filter: blur(10px);
	}
	
	.controls-section {
		display: flex;
		gap: 15px;
		margin-bottom: 20px;
	}
	
	.control-button {
		background: linear-gradient(145deg, #667eea, #764ba2);
		color: white;
		border: none;
		border-radius: 8px;
		padding: 10px 20px;
		cursor: pointer;
		font-weight: 600;
		transition: all 0.3s ease;
	}
	
	.control-button:hover {
		transform: translateY(-2px);
		box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
	}
	
	.control-button:disabled {
		opacity: 0.6;
		cursor: not-allowed;
		transform: none;
		box-shadow: none;
	}
	
	@keyframes pulse {
		0%, 100% { opacity: 1; }
		50% { opacity: 0.7; }
	}
</style>
{% endblock %}

{% block content %}
<div class="processing-monitor-container">
	<div class="container-fluid">
		<div class="row">
			<div class="col-12">
				<h1 class="text-white mb-4">
					<i class="fa fa-tachometer"></i> Real-Time Payroll Processing Monitor
				</h1>
			</div>
		</div>
		
		<!-- Status Header -->
		<div class="row">
			<div class="col-12">
				<div class="monitor-card">
					<div class="status-header">
						<div>
							<h2>{{ run.run_name }}</h2>
							<p class="text-muted">Run #{{ run.run_number }} • Started {{ run.started_at.strftime('%Y-%m-%d %H:%M:%S') if run.started_at else 'N/A' }}</p>
						</div>
						<div class="status-badge status-{{ status.status | lower | replace('_', '-') }}">
							<i class="fa fa-{{ 'cog fa-spin' if status.status == 'processing' else 'check' if status.status == 'completed' else 'exclamation-triangle' }}"></i>
							{{ status.status | title }}
						</div>
					</div>
					
					<div class="controls-section">
						<button class="control-button" onclick="toggleAutoRefresh()">
							<i class="fa fa-refresh"></i> Auto Refresh: <span id="autoRefreshStatus">ON</span>
						</button>
						<button class="control-button" onclick="refreshNow()">
							<i class="fa fa-sync"></i> Refresh Now
						</button>
						<button class="control-button" onclick="downloadLog()">
							<i class="fa fa-download"></i> Download Log
						</button>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Progress Section -->
		<div class="row">
			<div class="col-12">
				<div class="monitor-card">
					<div class="progress-section">
						<h3><i class="fa fa-tasks"></i> Processing Progress</h3>
						
						<div class="progress-bar-container">
							<div class="progress-bar" style="width: {{ status.progress_percentage }}%" id="progressBar"></div>
						</div>
						<div class="progress-text" id="progressText">{{ status.progress_percentage }}% Complete</div>
						
						<!-- Stage Indicator -->
						<div class="stage-indicator">
							{% set stages = [
								('initialization', 'Init'),
								('data_collection', 'Data'),
								('calculations', 'Calc'),
								('validations', 'Valid'),
								('ai_analysis', 'AI'),
								('compliance_check', 'Comply'),
								('approval_workflow', 'Approve'),
								('finalization', 'Final'),
								('completion', 'Done')
							] %}
							
							{% for stage_key, stage_label in stages %}
							<div class="stage-step">
								<div class="stage-circle {{ 'completed' if loop.index0 < stages.index((status.processing_stage, '')) else 'active' if stage_key == status.processing_stage else '' }}" id="stage-{{ stage_key }}">
									{{ loop.index }}
								</div>
								<div class="stage-label {{ 'completed' if loop.index0 < stages.index((status.processing_stage, '')) else 'active' if stage_key == status.processing_stage else '' }}">
									{{ stage_label }}
								</div>
							</div>
							{% endfor %}
						</div>
						
						<p class="text-center text-muted">
							Current Stage: <strong>{{ status.processing_stage | title | replace('_', ' ') }}</strong>
							{% if status.estimated_completion %}
							• Estimated Completion: <strong>{{ status.estimated_completion | parse_datetime | strftime('%H:%M:%S') }}</strong>
							{% endif %}
						</p>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Metrics Grid -->
		<div class="row">
			<div class="col-12">
				<div class="monitor-card">
					<h3><i class="fa fa-bar-chart"></i> Processing Metrics</h3>
					<div class="metrics-grid">
						<div class="metric-item">
							<div class="metric-value" id="employeeCount">{{ status.employee_count | default(0) }}</div>
							<div class="metric-label">Total Employees</div>
						</div>
						<div class="metric-item">
							<div class="metric-value" id="processedCount">{{ status.processed_employee_count | default(0) }}</div>
							<div class="metric-label">Processed</div>
						</div>
						<div class="metric-item">
							<div class="metric-value" id="errorCount">{{ status.error_count | default(0) }}</div>
							<div class="metric-label">Errors</div>
						</div>
						<div class="metric-item">
							<div class="metric-value" id="warningCount">{{ status.warning_count | default(0) }}</div>
							<div class="metric-label">Warnings</div>
						</div>
						<div class="metric-item">
							<div class="metric-value" id="validationScore">{{ "%.1f" | format(status.validation_score | default(0)) }}%</div>
							<div class="metric-label">Validation Score</div>
						</div>
						<div class="metric-item">
							<div class="metric-value" id="complianceScore">{{ "%.1f" | format(status.compliance_score | default(0)) }}%</div>
							<div class="metric-label">Compliance Score</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Employee Progress -->
		<div class="row">
			<div class="col-md-6">
				<div class="monitor-card">
					<h3><i class="fa fa-users"></i> Employee Processing Status</h3>
					<div class="employee-progress">
						<div class="employee-grid" id="employeeGrid">
							<!-- Employee cards will be populated by JavaScript -->
						</div>
					</div>
				</div>
			</div>
			
			<!-- Real-time Log -->
			<div class="col-md-6">
				<div class="monitor-card">
					<h3><i class="fa fa-terminal"></i> Real-time Processing Log</h3>
					<div class="real-time-log" id="processingLog">
						<!-- Log entries will be populated by JavaScript -->
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Refresh Indicator -->
	<div class="refresh-indicator" id="refreshIndicator">
		<i class="fa fa-sync fa-spin"></i>
		Updating data...
	</div>
</div>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script>
	let autoRefresh = true;
	let refreshInterval;
	const runId = '{{ run.run_id }}';
	
	// Initialize monitoring
	document.addEventListener('DOMContentLoaded', function() {
		startAutoRefresh();
		updateEmployeeGrid();
		updateProcessingLog();
	});
	
	function startAutoRefresh() {
		if (refreshInterval) clearInterval(refreshInterval);
		
		refreshInterval = setInterval(async function() {
			if (autoRefresh) {
				await refreshData();
			}
		}, 5000); // Refresh every 5 seconds
	}
	
	async function refreshData() {
		try {
			showRefreshIndicator();
			
			const response = await fetch(`{{ url_for("PayrollRunView.api_get_status", run_id=run.run_id) }}`);
			const status = await response.json();
			
			if (status.error) {
				console.error('Error fetching status:', status.error);
				return;
			}
			
			updateUI(status);
			
		} catch (error) {
			console.error('Failed to refresh data:', error);
		} finally {
			hideRefreshIndicator();
		}
	}
	
	function updateUI(status) {
		// Update progress bar
		const progressBar = document.getElementById('progressBar');
		const progressText = document.getElementById('progressText');
		progressBar.style.width = status.progress_percentage + '%';
		progressText.textContent = status.progress_percentage + '% Complete';
		
		// Update metrics
		document.getElementById('employeeCount').textContent = status.employee_count || 0;
		document.getElementById('processedCount').textContent = status.processed_employee_count || 0;
		document.getElementById('errorCount').textContent = status.error_count || 0;
		document.getElementById('warningCount').textContent = status.warning_count || 0;
		document.getElementById('validationScore').textContent = (status.validation_score || 0).toFixed(1) + '%';
		document.getElementById('complianceScore').textContent = (status.compliance_score || 0).toFixed(1) + '%';
		
		// Update stage indicators
		updateStageIndicators(status.processing_stage);
		
		// Update employee grid and log
		updateEmployeeGrid(status.employee_details);
		updateProcessingLog(status.recent_logs);
		
		// Stop auto-refresh if completed
		if (status.status === 'completed' || status.status === 'error') {
			autoRefresh = false;
			document.getElementById('autoRefreshStatus').textContent = 'OFF';
		}
	}
	
	function updateStageIndicators(currentStage) {
		const stages = [
			'initialization', 'data_collection', 'calculations', 'validations',
			'ai_analysis', 'compliance_check', 'approval_workflow', 'finalization', 'completion'
		];
		
		const currentIndex = stages.indexOf(currentStage);
		
		stages.forEach((stage, index) => {
			const stageElement = document.getElementById(`stage-${stage}`);
			const stageStep = stageElement.parentElement;
			
			stageElement.className = 'stage-circle';
			stageStep.querySelector('.stage-label').className = 'stage-label';
			
			if (index < currentIndex) {
				stageElement.classList.add('completed');
				stageStep.querySelector('.stage-label').classList.add('completed');
			} else if (index === currentIndex) {
				stageElement.classList.add('active');
				stageStep.querySelector('.stage-label').classList.add('active');
			}
		});
	}
	
	function updateEmployeeGrid(employeeDetails = null) {
		const grid = document.getElementById('employeeGrid');
		
		// Sample data if no real data provided
		if (!employeeDetails) {
			employeeDetails = [
				{ name: 'John Smith', status: 'completed', id: 'emp001' },
				{ name: 'Sarah Johnson', status: 'processing', id: 'emp002' },
				{ name: 'Mike Brown', status: 'completed', id: 'emp003' },
				{ name: 'Lisa Davis', status: 'pending', id: 'emp004' },
				{ name: 'David Wilson', status: 'error', id: 'emp005' },
				{ name: 'Emma Taylor', status: 'completed', id: 'emp006' }
			];
		}
		
		grid.innerHTML = employeeDetails.map(emp => `
			<div class="employee-card ${emp.status}">
				<div class="employee-name">${emp.name}</div>
				<div class="employee-status">${emp.status}</div>
			</div>
		`).join('');
	}
	
	function updateProcessingLog(recentLogs = null) {
		const log = document.getElementById('processingLog');
		
		// Sample log entries if no real data provided
		if (!recentLogs) {
			recentLogs = [
				{ timestamp: new Date().toLocaleTimeString(), level: 'info', message: 'Starting employee payroll calculations...' },
				{ timestamp: new Date().toLocaleTimeString(), level: 'info', message: 'Processed 15 employees successfully' },
				{ timestamp: new Date().toLocaleTimeString(), level: 'warn', message: 'Minor tax calculation adjustment for employee EMP002' },
				{ timestamp: new Date().toLocaleTimeString(), level: 'info', message: 'AI validation complete - 98% confidence score' },
				{ timestamp: new Date().toLocaleTimeString(), level: 'info', message: 'Compliance checks passed for all employees' }
			];
		}
		
		const logHTML = recentLogs.map(entry => `
			<div class="log-entry">
				<span class="log-timestamp">${entry.timestamp}</span>
				<span class="log-level ${entry.level}">${entry.level.toUpperCase()}</span>
				<span class="log-message">${entry.message}</span>
			</div>
		`).join('');
		
		log.innerHTML = logHTML;
		log.scrollTop = log.scrollHeight;
	}
	
	function toggleAutoRefresh() {
		autoRefresh = !autoRefresh;
		document.getElementById('autoRefreshStatus').textContent = autoRefresh ? 'ON' : 'OFF';
		
		if (autoRefresh) {
			startAutoRefresh();
		} else if (refreshInterval) {
			clearInterval(refreshInterval);
		}
	}
	
	function refreshNow() {
		refreshData();
	}
	
	function downloadLog() {
		// Generate and download processing log
		const logContent = document.getElementById('processingLog').textContent;
		const blob = new Blob([logContent], { type: 'text/plain' });
		const url = window.URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = `payroll-processing-log-${runId}.txt`;
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
		window.URL.revokeObjectURL(url);
	}
	
	function showRefreshIndicator() {
		document.getElementById('refreshIndicator').style.display = 'flex';
	}
	
	function hideRefreshIndicator() {
		document.getElementById('refreshIndicator').style.display = 'none';
	}
	
	// Cleanup on page unload
	window.addEventListener('beforeunload', function() {
		if (refreshInterval) {
			clearInterval(refreshInterval);
		}
	});
</script>
{% endblock %}